<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Collaborative IDE</title>
    <style>
      body {
        margin: 0;
        display: flex;
        height: 100vh;
        background-color: #1e1e1e;
        color: #fff;
        font-family: sans-serif;
      }
      #editor-container {
        flex: 1;
        height: 100%;
      }
      #sidebar {
        width: 300px;
        background: #252526;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #333;
      }
      #output {
        flex: 1;
        padding: 10px;
        font-family: "Consolas", monospace;
        white-space: pre-wrap;
        overflow-y: auto;
        font-size: 14px;
      }
      .header {
        padding: 10px;
        background: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      button {
        padding: 8px 16px;
        background: #0e639c;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #1177bb;
      }
      .error {
        color: #f48771;
      }
      select {
        padding: 5px;
        background: #3c3c3c;
        color: white;
        border: none;
      }
    </style>
  </head>
  <body>
    <div id="editor-container"></div>

    <div id="sidebar">
      <div class="header">
        <span>Console</span>
        <select id="language" onchange="changeLanguage()">
          <option value="python">Python</option>
          <option value="cpp">C++</option>
        </select>
        <button onclick="runCode()">â–¶ Run</button>
      </div>
      <div id="output"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <script>
      const socket = io();
      let editor;
      let isReceivingUpdate = false;

      // Get Room ID from URL (e.g. localhost:3000?room=123)
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get("room") || "default-room";

      require.config({
        paths: {
          vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs",
        },
      });

      require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(
          document.getElementById("editor-container"),
          {
            value: 'print("Loading...")',
            language: "python",
            theme: "vs-dark",
            automaticLayout: true,
          }
        );

        // Join the room once editor is ready
        socket.emit("join-room", roomId);

        // Listen for local typing
        editor.onDidChangeModelContent((event) => {
          if (isReceivingUpdate) return;
          const code = editor.getValue();
          socket.emit("code-update", { roomId, code });
        });
      });

      // --- Event Listeners ---

      socket.on("code-update", (newCode) => {
        if (editor && editor.getValue() !== newCode) {
          isReceivingUpdate = true;
          const pos = editor.getPosition(); // Save cursor
          editor.setValue(newCode);
          editor.setPosition(pos); // Restore cursor
          isReceivingUpdate = false;
        }
      });

      socket.on("language-update", (newLang) => {
        const dropdown = document.getElementById("language");
        if (dropdown.value !== newLang) {
          dropdown.value = newLang;
          monaco.editor.setModelLanguage(editor.getModel(), newLang);
        }
      });

      socket.on("execution-result", (result) => {
        const outputDiv = document.getElementById("output");
        outputDiv.innerText = "";
        if (result.output) outputDiv.innerText += result.output;
        if (result.error) {
          const errElem = document.createElement("span");
          errElem.classList.add("error");
          errElem.innerText = "\n" + result.error;
          outputDiv.appendChild(errElem);
        }
      });

      // --- Functions ---

      function changeLanguage() {
        const lang = document.getElementById("language").value;

        // Set Template Code locally
        let code = "";
        if (lang === "cpp") {
          code =
            '#include <iostream>\n\nint main() {\n    std::cout << "Hello from C++" << std::endl;\n    return 0;\n}';
        } else {
          code = 'print("Hello from Python")';
        }

        editor.setValue(code);
        monaco.editor.setModelLanguage(editor.getModel(), lang);

        // Tell Server to update the Room
        socket.emit("language-change", { roomId, language: lang });
        socket.emit("code-update", { roomId, code });
      }

      // public/index.html

      function runCode() {
        const outputDiv = document.getElementById("output");
        outputDiv.innerText = "Running...";
        outputDiv.classList.remove("error");

        const lang = document.getElementById("language").value; // <--- Get the language

        socket.emit("run-code", {
          roomId: roomId,
          language: lang, // <--- Send it to the server
          code: editor.getValue(),
        });
      }
    </script>
  </body>
</html>
