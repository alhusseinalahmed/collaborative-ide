<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Collaborative IDE</title>
    <style>
      body {
        margin: 0;
        display: flex;
        height: 100vh;
        background-color: #1e1e1e;
        color: #fff;
        font-family: sans-serif;
      }
      #editor-container {
        flex: 1;
        height: 100%;
      }
      #sidebar {
        width: 300px;
        background: #252526;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #333;
      }
      #output {
        flex: 1;
        padding: 10px;
        font-family: "Consolas", monospace;
        white-space: pre-wrap;
        overflow-y: auto;
        font-size: 14px;
      }
      .header {
        padding: 10px;
        background: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      button {
        padding: 8px 16px;
        background: #0e639c;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background: #1177bb;
      }
      .error {
        color: #f48771;
      } /* VS Code red color */
    </style>
  </head>
  <body>
    <div id="editor-container"></div>

    <div id="sidebar">
      <div class="header">
        <span>Console</span>
        <button onclick="runCode()">â–¶ Run</button>
      </div>
      <div id="output"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
      const socket = io();
      let editor; // Global variable for the editor instance
      let isReceivingUpdate = false; // Flag to prevent infinite loops

      // 1. Initialize Monaco Editor
      require.config({
        paths: {
          vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs",
        },
      });

      require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(
          document.getElementById("editor-container"),
          {
            value:
              'print("Hello from Monaco!")\nimport time\ntime.sleep(1)\nprint("Done")',
            language: "python",
            theme: "vs-dark", // The classic Dark Mode
            automaticLayout: true,
          }
        );

        // 2. Listen for changes (User Typing)
        editor.onDidChangeModelContent((event) => {
          // If the change came from the server, don't emit it back!
          if (isReceivingUpdate) return;

          const code = editor.getValue();
          socket.emit("code-update", code);
        });
      });

      // 3. Receive changes from other users
      socket.on("code-update", (newCode) => {
        if (editor && editor.getValue() !== newCode) {
          isReceivingUpdate = true; // Set flag

          // Save cursor position
          const position = editor.getPosition();

          editor.setValue(newCode);

          // Restore cursor position (Simple fix, not perfect yet)
          editor.setPosition(position);

          isReceivingUpdate = false; // Reset flag
        }
      });

      // 4. Run Code Logic
      function runCode() {
        const outputDiv = document.getElementById("output");
        outputDiv.innerText = "Running...";
        outputDiv.classList.remove("error");

        socket.emit("run-code", {
          language: "python",
          code: editor.getValue(), // Get code from Monaco
        });
      }

      socket.on("execution-result", (result) => {
        const outputDiv = document.getElementById("output");
        outputDiv.innerText = "";

        if (result.output) outputDiv.innerText += result.output;
        if (result.error) {
          const errElem = document.createElement("span");
          errElem.classList.add("error");
          errElem.innerText = "\n" + result.error;
          outputDiv.appendChild(errElem);
        }
      });
    </script>
  </body>
</html>
